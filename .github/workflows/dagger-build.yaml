---
name: ğŸ‘©â€ğŸš€ Dagger Build

on:
  push:
    branches: [main, master]
    paths:
      - 'pipeline/infra/**'
      - '.github/workflows/dagger-build.yaml'
  workflow_dispatch:
    inputs:
      dagger_version:
        description: 'Dagger version to use'
        required: false
        default: '0.18.8'
        type: string

permissions:
  contents: read
  pull-requests: read

env:
  DAGGER_VERSION: ${{ inputs.dagger_version || '0.18.8' }}
  DAGGER_MODULE_DIR: "pipeline/infra"

jobs:
  dagger-build:
    name: ğŸ”¨ Build Dagger Pipeline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Dagger CLI
        run: |
          curl -fsSL https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAGGER_VERSION }} BIN_DIR=$HOME/.local/bin sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ”§ Verify Dagger Installation
        run: |
          dagger version
          echo "âœ… Dagger CLI installed successfully"

      - name: ğŸ”¨ Initialize Dagger Development Environment
        working-directory: ${{ env.DAGGER_MODULE_DIR }}
        run: |
          echo "ğŸ”¨ Initializing Dagger development environment"
          dagger develop
          echo "âœ… Dagger development environment initialized successfully"

      - name: ğŸ“‹ Build Dagger Pipeline
        working-directory: ${{ env.DAGGER_MODULE_DIR }}
        run: |
          echo "ğŸ“‹ Building Dagger pipeline"
          dagger functions
          echo "âœ… Dagger pipeline built successfully"

  summary:
    name: ğŸ Build Summary
    needs:
      - dagger-build
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Workflow Status
        run: |
          echo "ğŸš€ Dagger Build Complete!"
          echo "ğŸ” Detailed results available in job logs."

          # Check the status of the build job
          if [[ "${{ needs.dagger-build.result }}" != "success" ]]; then
            echo "âŒ Dagger build failed"
            exit 1
          fi

          echo "âœ… All checks passed!"
