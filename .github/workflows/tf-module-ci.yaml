---
name: ğŸ§© TF Module-Specific CI

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: 'Terraform module name to validate (mandatory)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: read

env:
  TERRAFORM_VERSION: '1.10.0'
  TFLINT_VERSION: 'latest'
  TERRAFORM_DOCS_VERSION: 'latest'
  GO_VERSION: '1.21'

jobs:
  ci-module:
    name: ğŸŒ Module Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ”§ Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: ğŸ—‚ï¸ Cache TFLint Plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('modules/${{ inputs.module_name }}/.tflint.hcl') }}

      - name: ğŸ§° Setup Terraform Docs
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/

      - name: ğŸŒ¿ Module Preparation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ğŸ” Validating module: ${{ inputs.module_name }}"
          echo "ğŸ“‚ Current directory: $(pwd)"

      - name: ğŸ§¹ Terraform Format Check
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "âœ¨ Checking Terraform code formatting..."
          terraform fmt -check -recursive

      - name: ğŸ” TFLint Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ğŸ•µï¸ Running TFLint for module: ${{ inputs.module_name }}"
          tflint --version
          tflint --init
          tflint -f compact
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: ğŸ“„ Terraform Docs Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ğŸ“ Checking required documentation files..."

          # Step 1: Verify README.md exists
          if [ ! -f README.md ]; then
            echo "âŒ Missing README.md file in module: ${{ inputs.module_name }}"
            exit 1
          fi
          echo "âœ… README.md found"

          # Step 2: Verify .terraform-docs.yml exists
          if [ ! -f .terraform-docs.yml ]; then
            echo "âŒ Missing .terraform-docs.yml file in module: ${{ inputs.module_name }}"
            exit 1
          fi
          echo "âœ… .terraform-docs.yml found"

          echo "âœ… All required documentation files are present"

      - name: ğŸ—ï¸ Terraform Initialization
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ğŸš€ Initializing Terraform module..."
          terraform init -backend=false

      - name: ğŸ§ª Terraform Validation
        working-directory: modules/${{ inputs.module_name }}
        run: |
          echo "ğŸ”¬ Validating Terraform module configuration..."
          terraform validate

  discover-test-targets:
    name: ğŸ” Discover Test Targets
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.find-examples.outputs.examples }}
      unit_tests_exist: ${{ steps.check-unit-tests.outputs.exists }}
      examples_tests_exist: ${{ steps.check-examples-tests.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Find Example Implementations
        id: find-examples
        run: |
          # Find all directories under the example module directory
          EXAMPLES=$(find "examples/${{ inputs.module_name }}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "examples=${EXAMPLES}" >> $GITHUB_OUTPUT
          echo "ğŸŒŸ Discovered Examples: ${EXAMPLES}"

      - name: ğŸ” Check for Unit Tests
        id: check-unit-tests
        run: |
          UNIT_TEST_DIR="tests/modules/${{ inputs.module_name }}/unit"
          if [ -d "$UNIT_TEST_DIR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¬ Unit Tests Exist: true"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¬ Unit Tests Exist: false"
          fi

      - name: ğŸ” Check for Examples Tests
        id: check-examples-tests
        run: |
          EXAMPLES_TEST_DIR="tests/modules/${{ inputs.module_name }}/examples"
          if [ -d "$EXAMPLES_TEST_DIR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¬ Examples Tests Exist: true"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¬ Examples Tests Exist: false"
          fi

  ci-examples:
    name: ğŸŒˆ Example Validation - ${{ matrix.example }}
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.examples != '[]' && needs.discover-test-targets.outputs.examples != '' }}
    strategy:
      fail-fast: false
      matrix:
        example: ${{ fromJson(needs.discover-test-targets.outputs.examples) }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ§ª Validate Example - ${{ matrix.example }}
        run: |
          echo "ğŸ” Validating example: ${{ matrix.example }}"

          EXAMPLE_PATH="examples/${{ inputs.module_name }}/${{ matrix.example }}"
          echo "ğŸ“‚ Validating directory: ${EXAMPLE_PATH}"

          # Change to example directory
          cd "${EXAMPLE_PATH}"

          # Terraform fmt check
          echo "âœ¨ Checking Terraform formatting..."
          terraform fmt -check -recursive

          # Terraform init
          echo "ğŸš€ Initializing Terraform example..."
          terraform init -backend=false

          # Terraform validate
          echo "ğŸ§ª Validating Terraform configuration..."
          terraform validate

  ci-terratest-unit-readonly:
    name: ğŸ§ª Unit Tests (Readonly)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.unit_tests_exist == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ§ª Run Unit Tests (Readonly)
        working-directory: tests
        run: |
          echo "ğŸš€ Running Readonly Unit Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Ensure Go modules are up to date
          go mod tidy

          # Run the tests (without -parallel flag to avoid concurrency issues)
          go test -v -tags 'readonly,unit' -count=1 ./modules/${{ inputs.module_name }}/unit/...

  ci-terratest-examples-readonly:
    name: ğŸ§ª Examples Tests (Readonly)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    if: ${{ needs.discover-test-targets.outputs.examples_tests_exist == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ§ª Run Examples Tests (Readonly)
        working-directory: tests
        run: |
          echo "ğŸš€ Running Readonly Examples Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Find all terraform example directories and clean them
          cd ..
          find examples/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find examples/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true
          cd tests

          # Ensure Go modules are up to date
          go mod tidy

          # Run the tests (without -parallel flag to avoid concurrency issues)
          go test -v -tags 'readonly,examples' -count=1 ./modules/${{ inputs.module_name }}/examples/...

  ci-terratest-unit-integration:
    name: ğŸ§ª Unit Tests (Integration)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    # Integration tests are disabled by default (set to 'false') because they require cloud credentials
    # When enabled, we check if unit tests exist
    if: ${{ false && needs.discover-test-targets.outputs.unit_tests_exist == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ§ª Run Unit Tests (Integration)
        working-directory: tests
        run: |
          echo "ğŸš€ Running Integration Unit Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Ensure Go modules are up to date
          go mod tidy

          # Run the tests (without -parallel flag to avoid concurrency issues)
          go test -v -tags 'integration,unit' -count=1 ./modules/${{ inputs.module_name }}/unit/...

  ci-terratest-examples-integration:
    name: ğŸ§ª Examples Tests (Integration)
    needs: [ci-module, discover-test-targets]
    runs-on: ubuntu-latest
    # Integration tests are disabled by default (set to 'false') because they require cloud credentials
    # When enabled, we check if examples tests exist
    if: ${{ false && needs.discover-test-targets.outputs.examples_tests_exist == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ§ª Run Examples Tests (Integration)
        working-directory: tests
        run: |
          echo "ğŸš€ Running Integration Examples Tests for module: ${{ inputs.module_name }}"

          # Clean up any existing state before running
          find modules/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find modules/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true

          # Find all terraform example directories and clean them
          cd ..
          find examples/${{ inputs.module_name }} -name ".terraform" -type d -exec rm -rf {} \; 2>/dev/null || true
          find examples/${{ inputs.module_name }} -name ".terraform.lock.hcl" -type f -delete 2>/dev/null || true
          cd tests

          # Ensure Go modules are up to date
          go mod tidy

          # Run the tests (without -parallel flag to avoid concurrency issues)
          go test -v -tags 'integration,examples' -count=1 ./modules/${{ inputs.module_name }}/examples/...

  summary:
    name: ğŸ Validation Summary
    needs:
      - ci-module
      - ci-examples
      - ci-terratest-unit-readonly
      - ci-terratest-examples-readonly
      - ci-terratest-unit-integration
      - ci-terratest-examples-integration
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Workflow Status
        run: |
          echo "ğŸš€ Module-Specific Terraform CI Complete!"
          echo "âœ… Module: ${{ inputs.module_name }}"
          echo "ğŸ” Detailed results available in job logs."

          # Check the status of all jobs
          if [[ "${{ needs.ci-module.result }}" != "success" ]]; then
            echo "âŒ Module validation failed"
            exit 1
          fi

          # ci-examples may be skipped if there are no examples
          if [[ "${{ needs.ci-examples.result }}" != "success" && "${{ needs.ci-examples.result }}" != "skipped" ]]; then
            echo "âŒ Examples validation failed"
            exit 1
          fi

          # Unit tests (readonly) may be skipped if there are no unit tests
          if [[ "${{ needs.ci-terratest-unit-readonly.result }}" != "success" && "${{ needs.ci-terratest-unit-readonly.result }}" != "skipped" ]]; then
            echo "âŒ Unit tests (readonly) failed"
            exit 1
          fi

          # Examples tests (readonly) may be skipped if there are no examples tests
          if [[ "${{ needs.ci-terratest-examples-readonly.result }}" != "success" && "${{ needs.ci-terratest-examples-readonly.result }}" != "skipped" ]]; then
            echo "âŒ Examples tests (readonly) failed"
            exit 1
          fi

          # Integration tests are disabled by default, so they should be skipped
          if [[ "${{ needs.ci-terratest-unit-integration.result }}" != "success" && "${{ needs.ci-terratest-unit-integration.result }}" != "skipped" ]]; then
            echo "âŒ Unit tests (integration) failed"
            exit 1
          fi

          # Integration tests are disabled by default, so they should be skipped
          if [[ "${{ needs.ci-terratest-examples-integration.result }}" != "success" && "${{ needs.ci-terratest-examples-integration.result }}" != "skipped" ]]; then
            echo "âŒ Examples tests (integration) failed"
            exit 1
          fi

          echo "âœ… All checks passed!"
