---
name: 🚀 Semantic Releases

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

env:
  RELEASE_PLEASE_VERSION: 4.1.3

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🚀 Release Please
        uses: googleapis/release-please-action@v4
        id: release-please
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          release-type: terraform-module

      # Optional: Publish to package registries or perform additional release tasks
      - name: 📦 Publish Artifacts
        if: ${{ steps.release-please.outputs.release_created }}
        run: |
          echo "🎉 Release created for modules:"
          echo "${{ steps.release-please.outputs.paths_released }}"

      - name: 📝 Create GitHub Release
        if: ${{ steps.release-please.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for module in ${{ steps.release-please.outputs.paths_released }}; do
            version=$(jq -r ".[\"$module\"]" .release-please-manifest.json)
            echo "🏷️ Creating release for $module@$version"
            gh release create "v$version" \
              --title "Release $module v$version" \
              --notes-file "$module/CHANGELOG.md"
          done

  notify:
    needs: release-please
    runs-on: ubuntu-latest
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - name: 📢 Notify Release Channels
        run: |
          echo "🚀 Releases have been created successfully!"
          echo "📊 Check the GitHub Releases page for more details."
