---
name: ğŸ¦« Go Code Quality Checks

on:
  workflow_dispatch:
    inputs:
      go_version:
        description: 'Go version to use'
        required: false
        default: '1.23'
        type: string
      golangci_lint_version:
        description: 'GolangCI-Lint version to use'
        required: false
        default: 'v1.64.5'
        type: string
  push:
    paths:
      - 'tests/**'
      - 'pipeline/infra/**'
      - '.golangci-pipeline.yml'
      - '.golangci-tests.yml'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    types: [opened, edited, synchronize]
    paths:
      - 'tests/**'
      - 'pipeline/infra/**'
      - '.golangci-pipeline.yml'
      - '.golangci-tests.yml'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read
  pull-requests: read

env:
  GO_VERSION: ${{ inputs.go_version || '1.23' }}
  GOLANGCI_LINT_VERSION: ${{ inputs.golangci_lint_version || 'v1.64.5' }}

jobs:
  go-lint-pipeline:
    name: ğŸš€ Go Lint Pipeline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: ğŸ” Validate GolangCI-Lint Configuration
        run: |
          echo "ğŸ” Validating golangci-lint configuration for pipeline..."
          golangci-lint config verify --config .golangci-pipeline.yml
          echo "âœ… Configuration valid, proceeding with linting..."

      - name: ğŸ¨ Go Format Check
        working-directory: pipeline/infra
        run: |
          echo "âœ¨ Checking Go code formatting in pipeline..."
          gofmt_output=$(gofmt -l .)
          if [ -n "$gofmt_output" ]; then
            echo "âŒ Formatting issues found in files:"
            echo "$gofmt_output"
            exit 1
          fi

      - name: ğŸ•µï¸ Go Linter Pipeline
        uses: golangci/golangci-lint-action@v3
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          working-directory: pipeline/infra
          args: --config ../../.golangci-pipeline.yml --verbose
          skip-cache: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

  go-lint-tests:
    name: ğŸ§ª Go Lint Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: ğŸ§¹ Go Mod Tidy
        working-directory: tests
        run: |
          echo "ğŸ”„ Tidying Go module dependencies..."
          go mod tidy
          git diff --exit-code || (echo "âŒ go.mod/go.sum files were modified during tidy" && exit 1)

      - name: ğŸ” Validate GolangCI-Lint Configuration
        run: |
          echo "ğŸ” Validating golangci-lint configuration for tests..."
          golangci-lint config verify --config .golangci-tests.yml
          echo "âœ… Configuration valid, proceeding with linting..."

      - name: ğŸ¨ Go Format Check
        working-directory: tests
        run: |
          echo "âœ¨ Checking Go code formatting in tests..."
          gofmt_output=$(gofmt -l .)
          if [ -n "$gofmt_output" ]; then
            echo "âŒ Formatting issues found in files:"
            echo "$gofmt_output"
            exit 1
          fi

      - name: ğŸ•µï¸ Go Linter Tests
        uses: golangci/golangci-lint-action@v3
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          working-directory: tests
          args: --config ../.golangci-tests.yml --verbose
          skip-cache: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: ğŸ Quality Check Summary
    needs: [go-lint-pipeline, go-lint-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Workflow Status
        run: |
          echo "ğŸ¦« Go Code Quality Checks Complete!"
          echo "ğŸš€ Pipeline Lint: ${{ needs.go-lint-pipeline.result }}"
          echo "ğŸ§ª Tests Lint: ${{ needs.go-lint-tests.result }}"
          echo "ğŸ” Detailed results available in job logs."
          echo "ğŸ§¹ Go Version: ${{ env.GO_VERSION }}"
          echo "ğŸ§¹ Golangci-lint Version: ${{ env.GOLANGCI_LINT_VERSION }}"

          # Check pipeline lint result
          if [[ "${{ needs.go-lint-pipeline.result }}" != "success" ]]; then
            echo "âŒ Pipeline linting failed"
            exit 1
          fi

          # Check tests lint result
          if [[ "${{ needs.go-lint-tests.result }}" != "success" ]]; then
            echo "âŒ Tests linting failed"
            exit 1
          fi

          echo "âœ… All Go code quality checks passed!"
