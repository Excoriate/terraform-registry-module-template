---
name: ğŸ“š Terraform Modules CI

on:
  workflow_dispatch:
  push:
    paths:
      - 'modules/**'
      - '.github/workflows/tf-modules-ci.yaml'
      - '.tflint.hcl'
      - '.terraform-docs.yml'
  pull_request:
    types: [opened, edited, synchronize]
    paths:
      - 'modules/**'
      - '.github/workflows/tf-modules-ci.yaml'
      - '.tflint.hcl'
      - '.terraform-docs.yml'

permissions:
  contents: read
  pull-requests: read

env:
  TERRAFORM_VERSION: '1.10.0'
  TFLINT_VERSION: 'latest'
  TERRAFORM_DOCS_VERSION: 'latest'

jobs:
  detect-modules:
    name: ğŸ” Detect Terraform Modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“‹ Set Module Matrix
        id: set-matrix
        run: |
          # Dynamically find all modules with a main.tf file
          MODULES=$(find modules -maxdepth 2 -type f -name "main.tf" -exec dirname {} \; | sed 's|modules/||' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "matrix=${MODULES}" >> $GITHUB_OUTPUT

  terraform-module-validation:
    name: ğŸŒ Terraform Module Validation
    needs: detect-modules
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.detect-modules.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ”§ Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: ğŸ§° Setup Terraform Docs
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/

      - name: ğŸŒ¿ Module Preparation
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "ğŸ” Validating module: ${{ matrix.module }}"
          echo "ğŸ“‚ Current directory: $(pwd)"

      - name: ğŸ§¹ Terraform Format Check
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "âœ¨ Checking Terraform code formatting..."
          terraform fmt -check -recursive

      - name: ğŸ” TFLint Validation
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "ğŸ•µï¸ Running TFLint for module: ${{ matrix.module }}"
          tflint --init
          tflint --config=.tflint.hcl --recursive

      - name: ğŸ“„ Terraform Docs Validation
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "ğŸ“ Checking required documentation files..."

          # Step 1: Verify README.md exists
          if [ ! -f README.md ]; then
            echo "âŒ Missing README.md file in module: ${{ matrix.module }}"
            exit 1
          fi
          echo "âœ… README.md found"

          # Step 2: Verify .terraform-docs.yml exists
          if [ ! -f .terraform-docs.yml ]; then
            echo "âŒ Missing .terraform-docs.yml file in module: ${{ matrix.module }}"
            exit 1
          fi
          echo "âœ… .terraform-docs.yml found"

          # Step 3: Generate documentation using module's config
          echo "ğŸ”¬ Generating Terraform Docs using module configuration..."
          terraform-docs --config .terraform-docs.yml .

          # Step 4: Verify if documentation is up to date
          if [ -n "$(git status --porcelain README.md)" ]; then
            echo "âŒ README.md is out of sync with module configuration"
            echo "   Please run 'terraform-docs --config .terraform-docs.yml .' to update documentation"
            git diff README.md
            exit 1
          fi

          echo "âœ… Module documentation is up to date"

      - name: ğŸš€ Terraform Initialization
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "ğŸš€ Initializing Terraform module..."
          terraform init -backend=false

      - name: ğŸ§ª Terraform Validation
        working-directory: modules/${{ matrix.module }}
        run: |
          echo "ğŸ”¬ Validating Terraform module configuration..."
          terraform validate

  summary:
    name: ğŸ Module Validation Summary
    needs: [detect-modules, terraform-module-validation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Workflow Status
        run: |
          echo "ğŸŒ¿ Terraform Module Validation Complete!"
          echo "âœ… Modules Validated: ${{ needs.detect-modules.outputs.matrix }}"
          echo "ğŸ” Detailed results available in job logs."

        # Conditional status check
        if: |
          needs.terraform-module-validation.result == 'success'
